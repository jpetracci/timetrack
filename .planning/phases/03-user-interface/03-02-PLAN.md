---
phase: 03-user-interface
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/main.dart
  - lib/utils/decimal_time.dart
  - lib/services/settings_storage.dart
  - lib/state/settings_state.dart
  - lib/state/settings_controller.dart
  - lib/ui/screens/settings_screen.dart
  - lib/ui/widgets/timer_header.dart
  - lib/widgets/project_card.dart
autonomous: true

must_haves:
  truths:
    - "Time displays in decimal hours with user-selected precision (1-4)"
    - "Precision setting persists across app restarts"
    - "All time readouts include the 'h' suffix"
  artifacts:
    - path: "lib/utils/decimal_time.dart"
      provides: "Half-up rounding formatter with precision clamp"
    - path: "lib/state/settings_controller.dart"
      provides: "Riverpod settings state with precision persistence"
    - path: "lib/ui/screens/settings_screen.dart"
      provides: "Precision selector UI (1-4)"
  key_links:
    - from: "lib/state/settings_controller.dart"
      to: "shared_preferences"
      via: "SettingsStorage"
      pattern: "SharedPreferences"
    - from: "lib/ui/widgets/timer_header.dart"
      to: "lib/state/settings_controller.dart"
      via: "ref.watch(select)"
      pattern: "settings"
    - from: "lib/widgets/project_card.dart"
      to: "lib/utils/decimal_time.dart"
      via: "formatDecimalHours"
      pattern: "formatDecimalHours"
---

<objective>
Add configurable decimal time formatting with persistent precision settings and apply it across the UI.

Purpose: Satisfy DISP-01/DISP-02 and ensure consistent, deterministic time display.
Output: Settings-backed precision option, half-up rounding formatter, and updated time labels.
</objective>

<execution_context>
@/Users/joel/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/joel/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-user-interface/03-CONTEXT.md
@.planning/phases/03-user-interface/03-RESEARCH.md
@lib/utils/decimal_time.dart
@lib/ui/widgets/timer_header.dart
@lib/widgets/project_card.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings state and persistence for precision</name>
  <files>
    lib/services/settings_storage.dart
    lib/state/settings_state.dart
    lib/state/settings_controller.dart
    lib/main.dart
  </files>
  <action>
    Create a SettingsState with a precision field (default 2, clamped 1-4). Implement SettingsController as a Riverpod Notifier that lazily hydrates precision from SharedPreferences after runApp (or via a post-frame/init trigger) and persists updates via a SettingsStorage service. In main.dart, ensure settings providers are available but do not block first-frame rendering; default precision applies until hydration completes.
  </action>
  <verify>flutter analyze</verify>
  <done>App renders first frame without blocking, then precision hydrates and updates persist across app restarts.</done>
</task>

<task type="auto">
  <name>Task 2: Wire precision into formatting and settings UI</name>
  <files>
    lib/utils/decimal_time.dart
    lib/ui/screens/settings_screen.dart
    lib/ui/widgets/timer_header.dart
    lib/widgets/project_card.dart
  </files>
  <action>
    Update formatDecimalHours to round half-up and clamp precision to 1-4 before formatting with toStringAsFixed, returning a string that includes the 'h' suffix. Update TimerHeader and ProjectCard to read the precision from SettingsController (using ref.watch/select) and to use the updated formatter without double-appending the suffix. Implement a Settings screen control (segmented buttons or slider) that lets the user pick 1-4 decimal places and writes changes through the SettingsController.
  </action>
  <verify>flutter analyze</verify>
  <done>Changing precision in Settings immediately updates time labels in header and project cards, and the chosen value survives restart.</done>
</task>

</tasks>

<verification>
- `flutter analyze`
- Manual sanity: change precision to 4, confirm header/cards update and persist
</verification>

<success_criteria>
- Decimal hours display uses half-up rounding and chosen precision (1-4)
- All visible time labels include the "h" suffix
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-interface/03-02-SUMMARY.md`
</output>
