---
phase: 05-reporting
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - pubspec.yaml
  - lib/services/report_export_service.dart
  - lib/services/local_storage.dart
  - lib/ui/screens/settings_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can export all data as JSON or CSV"
    - "Exported files include projects and time entries"
    - "Existing projects and entries remain intact after app updates"
  artifacts:
    - path: "lib/services/report_export_service.dart"
      provides: "JSON/CSV export generation and share delivery"
    - path: "lib/services/local_storage.dart"
      provides: "Schema version tracking and migration runner"
    - path: "lib/ui/screens/settings_screen.dart"
      provides: "Export UI actions"
  key_links:
    - from: "lib/ui/screens/settings_screen.dart"
      to: "lib/services/report_export_service.dart"
      via: "ReportExportService.exportAll"
      pattern: "exportAll"
    - from: "lib/services/local_storage.dart"
      to: "shared_preferences"
      via: "schema_version key"
      pattern: "schema_version"
---

<objective>
Add data export and schema migration support for long-term persistence.

Purpose: Give users a portable backup and protect data across schema updates.
Output: Export service + UI actions, schema versioning in local storage, new dependencies.
</objective>

<execution_context>
@/Users/joel/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/joel/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting/05-RESEARCH.md

@lib/services/local_storage.dart
@lib/models/project.dart
@lib/models/time_entry.dart
@lib/ui/screens/settings_screen.dart
@pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export dependencies and report export service</name>
  <files>pubspec.yaml, lib/services/report_export_service.dart</files>
  <action>
Update `pubspec.yaml` dependencies to include `csv`, `path_provider`, and `share_plus` (use versions from 05-RESEARCH). Run `flutter pub get` after updating.

Create `ReportExportService` with:
- `ExportFormat` enum (`json`, `csv`).
- `Future<void> exportAll({required ExportFormat format, required List<Project> projects, required List<TimeEntry> entries})`.
- JSON export: encode `{exportedAt, schemaVersion, projects, entries}` with ISO-8601 strings.
- CSV export: generate two files (`projects.csv`, `entries.csv`) using `ListToCsvConverter`.
- Use `path_provider` to write files to the app documents directory (non-web).
- For web (`kIsWeb`), create `XFile.fromData` for JSON/CSV bytes without writing to disk.
- Share exported files via `SharePlus.instance.share(ShareParams(files: [...]))`.

Keep file names stable with a timestamp suffix like `timetrack_export_YYYYMMDD_HHMM`.
  </action>
  <verify>flutter analyze</verify>
  <done>Export service builds JSON/CSV files and can share them via the platform share sheet.</done>
</task>

<task type="auto">
  <name>Task 2: Wire export actions into Settings screen</name>
  <files>lib/ui/screens/settings_screen.dart, lib/services/report_export_service.dart</files>
  <action>
Add a "Data export" section to `SettingsScreen` with two buttons: Export JSON and Export CSV.

On tap:
- Read current `projects` and `entries` from `projectsControllerProvider` and `timerControllerProvider` (include `runningEntry` if present).
- Call `ReportExportService.exportAll` with the selected format.
- Show a snackbar on success and error (guard with `context.mounted`).

Keep the layout consistent with existing settings card styling.
  </action>
  <verify>flutter analyze</verify>
  <done>Settings screen exposes export actions and triggers share sheet for JSON/CSV.</done>
</task>

<task type="auto">
  <name>Task 3: Add schema versioning and migration hook in local storage</name>
  <files>lib/services/local_storage.dart</files>
  <action>
Add schema version tracking to `LocalStorage`:
- Define `_schemaVersionKey` and `_currentSchemaVersion`.
- Add a private `_migrateIfNeeded()` that loads the stored version (default 1), runs sequential migrations, and sets the version to current.
- Implement v1 -> v2 migration that reloads and re-saves projects and entries using current models to normalize stored JSON (adds missing fields like `isArchived`).
- Call `_migrateIfNeeded()` at the start of `loadProjects()` and `loadEntries()` to ensure migrations run before reads.

Keep migrations idempotent and avoid throwing on empty data.
  </action>
  <verify>flutter analyze</verify>
  <done>Local storage records a schema version and runs migrations before loading data.</done>
</task>

</tasks>

<verification>
- `flutter analyze`
- Manual smoke check: export buttons trigger share sheet
</verification>

<success_criteria>
- JSON and CSV exports are available from Settings and include project + entry data
- Schema version key is stored and migrations run on app start
- No analyzer errors after adding export dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting/05-03-SUMMARY.md`
</output>
