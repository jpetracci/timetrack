---
phase: 05-reporting
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - lib/state/reporting_state.dart
  - lib/state/reporting_controller.dart
  - lib/ui/screens/reports_screen.dart
  - lib/ui/widgets/report_table.dart
  - lib/ui/widgets/weekly_report_table.dart
autonomous: false

must_haves:
  truths:
    - "User can view a daily report showing time per project"
    - "User can view a weekly report with project totals and daily breakdown"
    - "User can change the report date range and see results update"
  artifacts:
    - path: "lib/ui/screens/reports_screen.dart"
      provides: "Report tabs, date range controls, and report sections"
    - path: "lib/state/reporting_controller.dart"
      provides: "Report view and date range state"
    - path: "lib/ui/widgets/report_table.dart"
      provides: "Daily report table layout"
    - path: "lib/ui/widgets/weekly_report_table.dart"
      provides: "Weekly breakdown table layout"
  key_links:
    - from: "lib/ui/screens/reports_screen.dart"
      to: "lib/utils/report_aggregation.dart"
      via: "buildDailyReport/buildWeeklyReport calls"
      pattern: "build(Daily|Weekly)Report"
    - from: "lib/ui/screens/reports_screen.dart"
      to: "lib/state/reporting_controller.dart"
      via: "reportingControllerProvider"
      pattern: "reportingControllerProvider"
---

<objective>
Deliver daily and weekly report views with date range filtering.

Purpose: Let users inspect time totals per project across day and week scopes.
Output: Reports screen UI, report state controller, and table widgets.
</objective>

<execution_context>
@/Users/joel/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/joel/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting/05-RESEARCH.md

@lib/ui/screens/reports_screen.dart
@lib/state/timer_controller.dart
@lib/state/projects_state.dart
@lib/state/settings_controller.dart
@lib/utils/report_aggregation.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reporting view + date range state</name>
  <files>lib/state/reporting_state.dart, lib/state/reporting_controller.dart, lib/ui/screens/reports_screen.dart</files>
  <action>
Create `ReportingState` with:
- `ReportView` enum (`daily`, `weekly`)
- `DateTimeRange range` representing inclusive start/end dates

Create `ReportingController` (Notifier) with default range set to the current week (Monday start) and helpers:
- `setView(ReportView view)`
- `setRange(DateTimeRange range)` (normalize to local midnight boundaries)
- `setToday()` (range = today only)
- `setThisWeek()` (range = current Monday-Sunday)

Update `ReportsScreen` to a `ConsumerWidget` and add header controls:
- SegmentedButton or ChoiceChips to switch daily/weekly view
- Date range display chip that opens `showDateRangePicker`
- Quick actions for Today and This Week

Keep range display compact and ensure it updates via `reportingControllerProvider`.
  </action>
  <verify>flutter analyze</verify>
  <done>Reports screen shows view toggles and date range controls wired to reporting state.</done>
</task>

<task type="auto">
  <name>Task 2: Build daily and weekly report tables</name>
  <files>lib/ui/screens/reports_screen.dart, lib/ui/widgets/report_table.dart, lib/ui/widgets/weekly_report_table.dart</files>
  <action>
Create `ReportTable` widget that renders a simple two-column layout (Project, Hours) plus a total row. Use `formatDecimalHours` with the precision from `SettingsController`.

In `ReportsScreen`, when `ReportView.daily` is selected:
- Combine `TimerState.entries` with `runningEntry` (if present) for current data.
- For each day in `daysInRange(range)`, call `buildDailyReport(projects, entries, day)`.
- Render a card per day with date label and `ReportTable` for that day.
- Show an empty state when no rows exist across the range.

Create `WeeklyReportTable` that renders a horizontal table:
- Columns: Project, Total, then each day label (Mon-Sun).
- Rows: one per project with totals and per-day durations formatted with `formatDecimalHours`.

In `ReportsScreen`, when `ReportView.weekly` is selected:
- Compute week start(s) within the selected range (start at Monday, step by 7 days).
- For each week start, call `buildWeeklyReport(projects, entries, weekStart)`.
- Render a section per week with a week range label and `WeeklyReportTable` inside a horizontal scroll.
- If range yields no weeks or rows, show the empty state.

Avoid heavy recomputation in build by using local variables and `select` on providers. Ensure weekly totals include entries spanning days by relying on `buildWeeklyReport`.
  </action>
  <verify>flutter analyze</verify>
  <done>Daily and weekly report views render correct tables with totals and per-day breakdowns.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Reports screen with daily/weekly views and date range filtering</what-built>
  <how-to-verify>
    1) Run the app and open the Reports tab.
    2) Toggle Daily/Weekly and confirm the table layout updates.
    3) Use the date range picker and verify totals update for the selected range.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `flutter analyze`
- Manual smoke check: reports render, range picker updates, tables update
</verification>

<success_criteria>
- Daily view shows per-project totals for each day in the selected range
- Weekly view shows per-project totals with daily breakdown columns
- Date range controls change the report output without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting/05-02-SUMMARY.md`
</output>
