---
phase: 05-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/models/report_models.dart
  - lib/utils/report_aggregation.dart
  - test/report_aggregation_test.dart
autonomous: true

must_haves:
  truths:
    - "Daily report totals match time entries for a chosen day"
    - "Entries spanning midnight contribute to each day they touch"
    - "Weekly breakdown returns per-project totals plus per-day durations"
  artifacts:
    - path: "lib/models/report_models.dart"
      provides: "Report row models for daily and weekly aggregates"
    - path: "lib/utils/report_aggregation.dart"
      provides: "Pure aggregation helpers for daily and weekly reports"
    - path: "test/report_aggregation_test.dart"
      provides: "Regression coverage for report aggregation edge cases"
  key_links:
    - from: "lib/utils/report_aggregation.dart"
      to: "lib/models/time_entry.dart"
      via: "entry start/end normalization"
      pattern: "TimeEntry"
    - from: "lib/utils/report_aggregation.dart"
      to: "lib/models/project.dart"
      via: "project name lookup by id"
      pattern: "Project"
---

<objective>
Define and verify report aggregation logic for daily and weekly summaries.

Purpose: Ensure reporting math is correct before wiring UI and filters.
Output: Tested aggregation helpers and report row models.
</objective>

<execution_context>
@/Users/joel/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/joel/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting/05-RESEARCH.md

@lib/models/time_entry.dart
@lib/models/project.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add report aggregation tests (daily + weekly + midnight split)</name>
  <files>test/report_aggregation_test.dart</files>
  <action>
Create tests for pure aggregation helpers using fixed DateTime values:
- Daily totals: two projects with entries on the same day return correct per-project hours.
- Midnight split: one entry from 23:00 to 01:00 splits into two days with 1h each.
- Weekly breakdown: a Monday-start week returns totals plus per-day durations for each project.
- Unknown project id: entries without a matching project map to "Unknown project" label.

Use `flutter_test` and explicit `DateTime` in local time; avoid `DateTime.now()` in tests.
  </action>
  <verify>flutter test test/report_aggregation_test.dart</verify>
  <done>Tests cover daily totals, midnight split behavior, weekly breakdowns, and unknown projects.</done>
</task>

<task type="auto">
  <name>Task 2: Implement report models and aggregation helpers</name>
  <files>lib/models/report_models.dart, lib/utils/report_aggregation.dart</files>
  <action>
Create report models:
- `ReportProjectTotal` with projectId, projectName, duration (Duration).
- `WeeklyProjectBreakdown` with projectId, projectName, dailyDurations (Map<DateTime, Duration>), totalDuration.

Implement pure helpers:
- `DateTime normalizeDay(DateTime value)` returning local midnight.
- `List<DateTime> daysInRange(DateTimeRange range)` (inclusive) for daily sections.
- `Map<DateTime, Duration> splitEntryByDay(TimeEntry entry)` that uses `end ?? DateTime.now()` and splits durations across day boundaries.
- `List<ReportProjectTotal> buildDailyReport(List<Project> projects, List<TimeEntry> entries, DateTime day)` that sums split durations for that day and sorts by duration desc.
- `List<WeeklyProjectBreakdown> buildWeeklyReport(List<Project> projects, List<TimeEntry> entries, DateTime weekStart)` that builds a 7-day breakdown using Monday as week start by default.

Ensure project lookups fall back to "Unknown project" when ids are missing, and ignore zero-duration rows.
  </action>
  <verify>flutter test test/report_aggregation_test.dart</verify>
  <done>All report aggregation tests pass and helpers return stable, sorted results.</done>
</task>

</tasks>

<verification>
- `flutter test test/report_aggregation_test.dart`
</verification>

<success_criteria>
- Aggregation helpers correctly split and sum durations across day boundaries
- Weekly breakdowns return per-day durations and total per project
- Tests run green without relying on `DateTime.now()`
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting/05-01-SUMMARY.md`
</output>
