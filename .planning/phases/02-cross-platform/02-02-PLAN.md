---
phase: 02-cross-platform
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/state/timer_controller.dart
  - lib/main.dart
autonomous: false
must_haves:
  truths:
    - "Timer elapsed time stays accurate after backgrounding and resuming"
    - "Active timer resumes after force-quit and app restart"
    - "Timer uses device clock as the source of truth"
  artifacts:
    - path: lib/state/timer_controller.dart
      provides: Lifecycle-aware elapsed recomputation
      contains: "DateTime.now().difference"
    - path: lib/main.dart
      provides: App lifecycle observer wiring
      contains: "WidgetsBindingObserver"
  key_links:
    - from: lib/main.dart
      to: lib/state/timer_controller.dart
      via: "lifecycle callback to timer controller"
      pattern: "didChangeAppLifecycleState"
    - from: lib/state/timer_controller.dart
      to: lib/services/local_storage.dart
      via: "active timer persistence"
      pattern: "saveActiveTimer|loadActiveTimer"
---

<objective>
Add lifecycle-aware timer behavior that stays accurate in background and across restarts.

Purpose: Meet TIMER-04 and TIMER-05 by deriving elapsed time from device clock and restoring on resume.
Output: Updated timer controller logic and app lifecycle hooks.
</objective>

<execution_context>
@/Users/joel/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/joel/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cross-platform/02-CONTEXT.md
@.planning/phases/02-cross-platform/02-RESEARCH.md
@lib/state/timer_controller.dart
@lib/main.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make elapsed time derive from device clock</name>
  <files>lib/state/timer_controller.dart</files>
  <action>
Refactor timer updates to always derive elapsed time from `DateTime.now()` and the stored `startTime`:
- Add a helper that computes elapsed from `startTime` and clamps negative durations to zero.
- Update `_startTicker` to call the helper on every tick and set `elapsed` immediately on start/resume.
- Add `handleAppPaused()` to stop the ticker without clearing timer state.
- Add `handleAppResumed()` to recompute elapsed from `startTime` and restart the ticker when running.
Keep persistence logic intact (save active timer on start, clear on stop).
  </action>
  <verify>Start a timer, wait a few seconds, and confirm elapsed continues to update from start time without drift.</verify>
  <done>Elapsed time always reflects `DateTime.now() - startTime`, including after pause/resume.</done>
</task>

<task type="auto">
  <name>Task 2: Wire app lifecycle to timer controller</name>
  <files>lib/main.dart</files>
  <action>
Add an app lifecycle observer that forwards pause/resume events to the timer controller:
- Convert `TimeTrackApp` to a `ConsumerStatefulWidget` implementing `WidgetsBindingObserver`.
- On `resumed`, call `handleAppResumed()`.
- On `paused`, `inactive`, or `hidden`, call `handleAppPaused()`.
- Ensure observers are registered in `initState` and removed in `dispose`.
Keep MaterialApp configuration unchanged.
  </action>
  <verify>`flutter test` passes.</verify>
  <done>Lifecycle transitions trigger timer pause/resume handling without altering UI structure.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Lifecycle-aware timer behavior for background/resume and restart</what-built>
  <how-to-verify>
    1. Run on a device or simulator and start a project timer.
    2. Background the app for ~10 seconds, then resume.
    3. Confirm the elapsed time jumps forward by the elapsed wall time (no freeze).
    4. Force-quit the app while the timer is running, reopen, and confirm the timer resumes with elapsed time based on device clock.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues observed.</resume-signal>
</task>

</tasks>

<verification>
- Timer elapsed reflects wall-clock time after backgrounding and resume.
- Active timer restores on app relaunch without resetting.
</verification>

<success_criteria>
- TIMER-04 and TIMER-05 behaviors are achieved across iOS, Android, and web.
</success_criteria>

<output>
After completion, create `.planning/phases/02-cross-platform/02-02-SUMMARY.md`
</output>
