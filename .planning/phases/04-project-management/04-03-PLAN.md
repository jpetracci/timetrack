---
phase: 04-project-management
plan: 03
type: execute
wave: 3
depends_on: ["02"]
files_modified:
  - lib/ui/screens/project_details_screen.dart
  - lib/widgets/time_entry_tile.dart
  - lib/state/timer_controller.dart
autonomous: false

must_haves:
  truths:
    - "User can see a project’s complete time history with start/end/duration"
    - "User can edit a past time entry’s duration"
    - "User can delete a time entry from history"
  artifacts:
    - path: "lib/ui/screens/project_details_screen.dart"
      provides: "Time history section wired to timer entries"
    - path: "lib/widgets/time_entry_tile.dart"
      provides: "Entry row UI with edit/delete actions"
    - path: "lib/state/timer_controller.dart"
      provides: "updateEntryDuration and deleteEntry mutations with persistence"
  key_links:
    - from: "lib/ui/screens/project_details_screen.dart"
      to: "lib/state/timer_controller.dart"
      via: "filter entries by projectId"
      pattern: "entries\.where\(.*projectId"
    - from: "lib/widgets/time_entry_tile.dart"
      to: "lib/state/timer_controller.dart"
      via: "updateEntryDuration/deleteEntry"
      pattern: "updateEntryDuration|deleteEntry"
---

<objective>
Build time history UI with inline edit/delete.

Purpose: Let users review and correct tracked time on a per-project basis.
Output: Time history list on project details, entry row widget, and edit/delete mutations.
</objective>

<execution_context>
@/Users/joel/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/joel/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-project-management/04-RESEARCH.md

@lib/models/time_entry.dart
@lib/state/timer_controller.dart
@lib/ui/screens/project_details_screen.dart
@lib/utils/decimal_time.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add time history section to project details</name>
  <files>lib/ui/screens/project_details_screen.dart, lib/widgets/time_entry_tile.dart</files>
  <action>
In `ProjectDetailsScreen`, read `timerControllerProvider` entries and filter by `projectId`, sorting most recent first. Include the running entry for this project at the top (if present), marked as "Running" and with actions disabled. Add a "Time history" section that renders a list of `TimeEntryTile` rows with start time, end time (or "Running"), and duration using `formatDecimalHours`.

Implement `TimeEntryTile` to format start/end using `TimeOfDay.fromDateTime(...).format(context)` and a simple date label (no new dependencies). Provide placeholders for edit/delete actions that can be enabled in Task 2.
  </action>
  <verify>flutter analyze</verify>
  <done>Project details shows a time history list with start/end/duration and an empty state when no entries exist.</done>
</task>

<task type="auto">
  <name>Task 2: Enable edit duration and delete entry actions</name>
  <files>lib/state/timer_controller.dart, lib/ui/screens/project_details_screen.dart, lib/widgets/time_entry_tile.dart</files>
  <action>
Add `TimerController.updateEntryDuration(entryId, Duration newDuration)` to update non-running entries by setting `end = start + newDuration`. Validate `newDuration > Duration.zero`; reject and show a snackbar on invalid input. Add `TimerController.deleteEntry(entryId)` to remove the entry and persist.

In `TimeEntryTile`, wire edit and delete actions for non-running entries. Edit opens a bottom sheet with a decimal-hours TextField (prefill with current duration in hours), validates numeric > 0, then calls `updateEntryDuration`. Delete opens an `AlertDialog` confirmation and calls `deleteEntry`. Use snackbars for error feedback and guard async UI with `context.mounted`.
  </action>
  <verify>flutter analyze</verify>
  <done>Editing an entry updates its duration/end time, and deleting removes the entry from history.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Time history list with edit/delete capabilities</what-built>
  <how-to-verify>
    1) Open a project details screen with existing entries.
    2) Edit a past entry duration and confirm the duration updates.
    3) Delete an entry and confirm it disappears and stays gone after restart.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `flutter analyze`
- Manual smoke check: history list, edit duration, delete entry
</verification>

<success_criteria>
- Project details shows full time history with readable start/end/duration
- Entry edits update end time while preserving start time
- Deleting entries removes them immediately and persists across reloads
</success_criteria>

<output>
After completion, create `.planning/phases/04-project-management/04-03-SUMMARY.md`
</output>
